---
title: "Statistical Inference"
author: "Ian Dinwoodie"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(tidymodels)
library(MASS)
library(caret)
library(car)
library(performance)
library(lme4)

knitr::opts_chunk$set(echo=TRUE)
set.seed(1)
```

# Preparing the Data

## Loading the Tidy Data

Load the tidy data from disk.

```{r}
df <- readRDS('../data/processed/tidy.Rds')
#stopifnot(identical(dim(df)+0, c(1405, 28)))
str(df, list.len=5)
```

## Drop/Rename/Reorder Columns

Drop or adjust (rename/reorder) columns.

```{r}
old_names <- c(
  colnames(df %>% dplyr::select(contains("rank") & !contains("revised"))),
  "time_thinking", "primary_motivation", "acquisition_source",
  "is_living_with_dog", "age", "is_male")
new_names <- c(
  "ch.age", "ch.appearance", "ch.breed", "ch.compatability", "ch.personality",
  "ch.size", "ch.trainability", "think_len", "motive", "source",
  "is_with_dog", "owner_age", "is_owner_male")

df <- df %>%
  dplyr::rename_with(~ new_names, all_of(old_names)) %>%
  dplyr::select(
    -dog_name,
    -met_expectations,
    -time_together_len,
    -curr_dog_location,
    -is_consider_another_dog,
    -is_with_dog,
    -contains("revised")
  ) %>%
  dplyr::mutate(owner_id = as.numeric(as.factor(owner_id))) %>%
  dplyr::relocate(is_owner_male, .before = everything()) %>%
  dplyr::relocate(owner_age , .after=is_owner_male) %>%
  dplyr::relocate(is_satisfied, .after = last_col()) %>%
  tidyr::drop_na()

rm(old_names, new_names)
dim(df)
summary(df)
```

# Preprocessing

Assign rank points for ease of interpretation.

```{r, fig.width=5, fig.height=3}
df <- df %>%
  # Assign best rank the most points (1st=7, 2nd=6, ..., 7th=1).
  dplyr::mutate(dplyr::across(contains("ch."), ~ 8 - .))
```

Create dummy variables.

```{r}
# Reference: https://bookdown.org/rehk/stm1001_dsm_introduction_to_machine_learning_in_r/machine-learning-in-r-using-the-caret-package.html
dummies <- dummyVars(is_satisfied ~ ., data = df, fullRank = T)
df_pp <- cbind(as_tibble(predict(dummies, newdata = df)),
               is_satisfied=df$is_satisfied)
df_pp <- df_pp %>%
  dplyr::rename(is_owner_male=is_owner_maleTRUE)

head(df_pp)
```

Check for near-zero variance variables.

```{r}
(nzv_metrics <- nearZeroVar(df_pp, saveMetrics=TRUE))
nzv_cnt <- sum(nzv_metrics$nzv)
print(paste("Warning:", nzv_cnt, "near-zero variance vars. found"))
if (nzv_cnt) {
  print(colnames(df_pp[, nzv_metrics$nzv]))
}
```

Instead of discarding the near-zero variance variables, we collapse fields or
portions of fields and check to see if the diagnostics are improved.

```{r}
df2 <- df %>%
  dplyr::mutate(think_len = ifelse(
    think_len %in% c("lt_one_wk", "one_wk_to_six_mo"), F, T)) %>%
  dplyr::rename(is_think_gt_6_mos=think_len) %>%
  dplyr::mutate(motive = forcats::fct_relevel(motive, "companionship")) %>%
  dplyr::mutate(
    source = forcats::fct_collapse(
      source,
      rescue=c("found"),
      pet_shop=c("online")
    )
  ) %>%
  dplyr::mutate(source = forcats::fct_relevel(source, "pet_shop")) %>%
  dplyr::filter(source != "foreign") %>%
  droplevels()
summary(df2)

dummies <- dummyVars(is_satisfied ~ ., data = df2, fullRank=T)
df_pp <- cbind(as_tibble(predict(dummies, newdata = df2)),
               is_satisfied=df2$is_satisfied)
df_pp <- df_pp %>%
  dplyr::rename(is_owner_male=is_owner_maleTRUE,
                is_think_gt_6_mos=is_think_gt_6_mosTRUE)
head(df_pp)

(nzv_metrics <- nearZeroVar(df_pp, saveMetrics=TRUE))
nzv_cnt <- sum(nzv_metrics$nzv)
print(paste("Warning:", nzv_cnt, "near-zero variance vars. found"))
if (nzv_cnt) {
  print(colnames(df_pp[, nzv_metrics$nzv]))
}
```

Check for linearly correlated predictors.

```{r}
#df_pp <- df_pp %>% dplyr::select(-motive.working)

combo_info <- findLinearCombos(
  df_pp %>% dplyr::select(-contains("ch."), -is_satisfied))
combo_cnt <- length(combo_info$remove)
print(paste("Linearly corr. combos vars to examine:", combo_cnt))
print(paste("Warning:", combo_cnt, "linearly corr. combos vars. found"))
if (combo_cnt) {
  print(colnames(df_pp)[combo_info$remove])
}
```

```{r}
str(df_pp)
```

# Models

## Null Model

```{r}
glm_fit_null <- glm(is_satisfied~1, df_pp, family="binomial")

(r2_mz_null <- performance::r2_mckelvey(glm_fit_null))
performance::r2_nagelkerke(glm_fit_null)
```

## Background Variables

```{r}
df_back <- df_pp %>%
  dplyr::select(is_satisfied, is_owner_male, owner_age, is_think_gt_6_mos, owner_id)
summary(df_back)
```

```{r}
set.seed(1)
glmer_fit<- glmer(is_satisfied ~ is_owner_male + owner_age + is_think_gt_6_mos + (1 | owner_id),
                  data = df_back, family = binomial(link = "logit"))
summary(glmer_fit)

performance::r2(glmer_fit)
```

```{r}
set.seed(1)
glm_fit_back <- glm(is_satisfied ~ ., df_back, family="binomial")
summary(glm_fit_back)

(r2_mz_back <- performance::r2_mckelvey(glm_fit_back))
print(paste("Delta R^2(mz):", r2_mz_back-r2_mz_null))
performance::r2_nagelkerke(glm_fit_back)
performance::performance_hosmer(glm_fit_back)
```

```{r}
print(vif(glm_fit_back))
```

```{r}
bs_table <- function(fit, data) {
  df_results <- broom::tidy(fit, conf.int=TRUE, exponentiate=TRUE)
  
  glm_est <- function(split, ...) {
    glm(fit$formula, data = rsample::analysis(split), family="binomial") %>%
      tidy()
  }
  
  set.seed(1)
  conf_ints <- rsample::bootstraps(data, 1000, apparent = TRUE) %>%
    dplyr::mutate(results = map(splits, glm_est)) %>%
    rsample::int_bca(results, .fn = glm_est) %>%
    dplyr::mutate_at(c(".estimate", ".lower", ".upper"), ~ exp(.)) %>%
    dplyr::select(term, .lower, .upper) %>%
    dplyr::rename(bs.low=.lower, bs.high=.upper)
  
  df_results <- merge(df_results, conf_ints, by="term")
  df_results$p.value <- p.adjust(df_results$p.value, method='fdr')
  df_results$sig <- ''
  df_results[df_results$p.value <= .05, 'sig'] <- '*'
  df_results[df_results$p.value <= .01, 'sig'] <- '**'
  df_results[df_results$p.value <= .001, 'sig'] <- '***'
  for (i in 1:nrow(df_results)) {
    if (is.na(df_results[i, 'bs.low']) | is.na(df_results[i, 'bs.high'])) next
    if ((df_results[i, 'bs.low'] <= 1) & (df_results[i, 'bs.high'] >= 1)) {
      df_results[i, 'sig'] <- ''
    }
  }
  df_results <- df_results %>%
    dplyr::mutate(dplyr::across(where(is.numeric), round, 3))
  return(knitr::kable(df_results))
}

bs_table(glm_fit_back, df_back)
```

```{r}
anova(glm_fit_null, glm_fit_back, test="LRT")
```

## Source

```{r}
df_source <- df_pp %>%
  dplyr::select(is_satisfied, is_owner_male, owner_age, is_think_gt_6_mos,
                contains("source."), owner_id)
summary(df_source)
```

```{r}
set.seed(1)
glmer_fit<- glmer(is_satisfied ~ . - owner_id + (1 | owner_id),
                  data = df_source, family = binomial(link = "logit"))
summary(glmer_fit)

performance::r2(glmer_fit)
```

```{r}
set.seed(1)
glm_fit_source <- glm(is_satisfied ~ ., df_source, family="binomial")
summary(glm_fit_source)

(r2_mz_source <- performance::r2_mckelvey(glm_fit_source))
print(paste("Delta R^2(mz):", r2_mz_source-r2_mz_back))
performance::r2_nagelkerke(glm_fit_source)
performance::performance_hosmer(glm_fit_source)
```

```{r}
print(vif(glm_fit_source))
```

```{r}
bs_table(glm_fit_source, df_source)
```

```{r}
anova(glm_fit_back, glm_fit_source, test="LRT")
```

## Motive

```{r}
df_motive <- df_pp %>%
  dplyr::select(is_satisfied, is_owner_male, owner_age,
                is_think_gt_6_mos, contains("source."), contains("motive."),
                owner_id)
summary(df_motive)
```

```{r}
set.seed(1)
glmer_fit<- glmer(is_satisfied ~ . - owner_id + (1 | owner_id),
                  data = df_motive, family = binomial(link = "logit"))
summary(glmer_fit)

performance::r2(glmer_fit)
```

```{r}
set.seed(1)
glm_fit_motive <- glm(is_satisfied~., df_motive, family="binomial")
summary(glm_fit_motive)

(r2_mz_motive <- performance::r2_mckelvey(glm_fit_motive))
print(paste("Delta R^2(mz):", r2_mz_motive-r2_mz_source))
performance::r2_nagelkerke(glm_fit_motive)
performance::performance_hosmer(glm_fit_motive)
```

```{r}
print(vif(glm_fit_motive))
```

```{r}
bs_table(glm_fit_motive, df_motive)
```

```{r}
anova(glm_fit_source, glm_fit_motive, test="LRT")
```

## Characteristics

### Age

```{r}
char <- "ch.age"
df_char <- df_pp %>%
  dplyr::select(is_satisfied, is_owner_male, owner_age,
                is_think_gt_6_mos, contains("source."), contains("motive."),
                !!!char)
summary(df_char)
```

```{r}
set.seed(1)
glm_fit_char <- glm(is_satisfied~., df_char, family="binomial")
summary(glm_fit_char)

(r2_mz_char <- performance::r2_mckelvey(glm_fit_char))
print(paste("Delta R^2(mz):", r2_mz_char-r2_mz_motive))
performance::r2_nagelkerke(glm_fit_char)
performance::performance_hosmer(glm_fit_char)
```

```{r}
print(vif(glm_fit_char))
```

```{r}
bs_table(glm_fit_char, df_char)
```

```{r}
anova(glm_fit_motive, glm_fit_char, test="Chisq")
```

### Appearance

```{r}
char <- "ch.appearance"
df_char <- df_pp %>%
  dplyr::select(is_satisfied, is_owner_male, owner_age,
                is_think_gt_6_mos, contains("source."), contains("motive."),
                !!!char)
summary(df_char)
```

```{r}
set.seed(1)
glm_fit_char <- glm(is_satisfied~., df_char, family="binomial")
summary(glm_fit_char)

(r2_mz_char <- performance::r2_mckelvey(glm_fit_char))
print(paste("Delta R^2(mz):", r2_mz_char-r2_mz_motive))
performance::r2_nagelkerke(glm_fit_char)
performance::performance_hosmer(glm_fit_char)
```

```{r}
print(vif(glm_fit_char))
```

```{r}
bs_table(glm_fit_char, df_char)
```

```{r}
anova(glm_fit_motive, glm_fit_char, test="Chisq")
```

### Breed

```{r}
char <- "ch.breed"
df_char <- df_pp %>%
  dplyr::select(is_satisfied, is_owner_male, owner_age,
                is_think_gt_6_mos, contains("source."), contains("motive."),
                !!!char)
summary(df_char)
```

```{r}
set.seed(1)
glm_fit_char <- glm(is_satisfied~., df_char, family="binomial")
summary(glm_fit_char)

(r2_mz_char <- performance::r2_mckelvey(glm_fit_char))
print(paste("Delta R^2(mz):", r2_mz_char-r2_mz_motive))
performance::r2_nagelkerke(glm_fit_char)
performance::performance_hosmer(glm_fit_char)
```

```{r}
print(vif(glm_fit_char))
```

```{r}
bs_table(glm_fit_char, df_char)
```

```{r}
anova(glm_fit_motive, glm_fit_char, test="Chisq")
```

### Compatability

```{r}
char <- "ch.compatability"
df_char <- df_pp %>%
  dplyr::select(is_satisfied, is_owner_male, owner_age,
                is_think_gt_6_mos, contains("source."), contains("motive."),
                !!!char)
summary(df_char)
```

```{r}
set.seed(1)
glm_fit_char <- glm(is_satisfied~., df_char, family="binomial")
summary(glm_fit_char)

(r2_mz_char <- performance::r2_mckelvey(glm_fit_char))
print(paste("Delta R^2(mz):", r2_mz_char-r2_mz_motive))
performance::r2_nagelkerke(glm_fit_char)
performance::performance_hosmer(glm_fit_char)
```

```{r}
print(vif(glm_fit_char))
```

```{r}
bs_table(glm_fit_char, df_char)
```

```{r}
anova(glm_fit_motive, glm_fit_char, test="Chisq")
```

### Personality

```{r}
char <- "ch.personality"
df_char <- df_pp %>%
  dplyr::select(is_satisfied, is_owner_male, owner_age,
                is_think_gt_6_mos, contains("source."), contains("motive."),
                !!!char, owner_id)
summary(df_char)
```

```{r}
set.seed(1)
glmer_fit<- glmer(is_satisfied ~ . - owner_id + (1 + ch.personality | owner_id),
                  data = df_char, family = binomial(link = "logit"))
summary(glmer_fit)

performance::r2(glmer_fit)
```

```{r}
set.seed(1)
glm_fit_char <- glm(is_satisfied~.+owner_id:ch.personality, df_char, family="binomial")
summary(glm_fit_char)

(r2_mz_char <- performance::r2_mckelvey(glm_fit_char))
print(paste("Delta R^2(mz):", r2_mz_char-r2_mz_motive))
performance::r2_nagelkerke(glm_fit_char)
performance::performance_hosmer(glm_fit_char)

print(vif(glm_fit_char))
```

```{r}
print(vif(glm_fit_char))
```

```{r}
bs_table(glm_fit_char, df_char)
```

```{r}
anova(glm_fit_motive, glm_fit_char, test="Chisq")
```

### Size

```{r}
char <- "ch.size"
df_char <- df_pp %>%
  dplyr::select(is_satisfied, is_owner_male, owner_age,
                is_think_gt_6_mos, contains("source."), contains("motive."),
                !!!char)
summary(df_char)
```

```{r}
set.seed(1)
glm_fit_char <- glm(is_satisfied~., df_char, family="binomial")
summary(glm_fit_char)

(r2_mz_char <- performance::r2_mckelvey(glm_fit_char))
print(paste("Delta R^2(mz):", r2_mz_char-r2_mz_motive))
performance::r2_nagelkerke(glm_fit_char)
performance::performance_hosmer(glm_fit_char)
```

```{r}
print(vif(glm_fit_char))
```

```{r}
bs_table(glm_fit_char, df_char)
```

```{r}
anova(glm_fit_motive, glm_fit_char, test="Chisq")
```

### Trainability

```{r}
char <- "ch.trainability"
df_char <- df_pp %>%
  dplyr::select(is_satisfied, is_owner_male, owner_age,
                is_think_gt_6_mos, contains("source."), contains("motive."),
                !!!char)
summary(df_char)
```

```{r}
set.seed(1)
glm_fit_char <- glm(is_satisfied~., df_char, family="binomial")
summary(glm_fit_char)

(r2_mz_char <- performance::r2_mckelvey(glm_fit_char))
print(paste("Delta R^2(mz):", r2_mz_char-r2_mz_motive))
performance::r2_nagelkerke(glm_fit_char)
performance::performance_hosmer(glm_fit_char)
```

```{r}
print(vif(glm_fit_char))
```

```{r}
bs_table(glm_fit_char, df_char)
```

```{r}
anova(glm_fit_motive, glm_fit_char, test="Chisq")
```

# Save Session Info

```{r}
sessionInfo()
```
